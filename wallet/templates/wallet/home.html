{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coco Wallet - AI-Powered Crypto Investment</title>
    <link rel="stylesheet" href="{% static 'website/css/style.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="{% static 'website/images/favicon.ico' %}" type="image/x-icon">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <style>
        .logo img {
            transform-origin: center center;
            transition: transform 0.3s ease;
        }
        .download-link[data-downloading="true"],
        .download-btn[data-downloading="true"],
        [id="heroDownloadBtn"][data-downloading="true"] {
            opacity: 0.5;
            pointer-events: none;
            cursor: not-allowed;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .fa-spin {
            animation: spin 1s linear infinite;
            display: inline-block;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="logo">
                <img src="{% static 'website/images/logo.png' %}" alt="Coco Wallet Logo">
            </div>
            <button class="mobile-menu-btn">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </button>
            <div class="nav-links">
                <a href="#home">Home</a>
                <a href="#about">About</a>
                <a href="#how-it-works">How It Works</a>
                <a href="#why-meme">Why Meme Coins</a>
                <a href="/download/app?ref={{ referrer_code }}&temp_id={{ temp_device_id }}" class="download-btn download-link">Download App</a>
            </div>
        </div>
    </nav>

    <script>
        // Mobile menu interaction
        document.querySelector('.mobile-menu-btn').addEventListener('click', function() {
            this.classList.toggle('active');
            document.querySelector('.nav-links').classList.toggle('active');
            document.body.classList.toggle('menu-open');
        });

        // Close menu after clicking links
        document.querySelectorAll('.nav-links a').forEach(link => {
            link.addEventListener('click', () => {
                document.querySelector('.mobile-menu-btn').classList.remove('active');
                document.querySelector('.nav-links').classList.remove('active');
                document.body.classList.remove('menu-open');
            });
        });

        // Logo rotation effect
        let lastScrollPosition = window.scrollY;
        window.addEventListener('scroll', () => {
            const currentScrollPosition = window.scrollY;
            const scrollDifference = currentScrollPosition - lastScrollPosition;
            const rotationSpeed = 0.5; // Rotation speed coefficient
            const logo = document.querySelector('.logo img');
            const currentRotation = parseFloat(logo.style.transform.replace('rotate(', '').replace('deg)', '') || 0);
            const newRotation = currentRotation + (scrollDifference * rotationSpeed);
            logo.style.transform = `rotate(${newRotation}deg)`;
            lastScrollPosition = currentScrollPosition;
        });

        // 生成更可靠的设备指纹
        function generateDeviceFingerprint() {
            const components = [
                navigator.userAgent,
                navigator.language,
                new Date().getTimezoneOffset(),
                screen.width + 'x' + screen.height + 'x' + screen.colorDepth,
                navigator.deviceMemory || '',
                navigator.hardwareConcurrency || '',
                navigator.platform || ''
            ];
            
            const fingerprint = components.join('|||');
            const hash = hashCode(fingerprint);
            return 'web_' + Math.abs(hash).toString(16);
        }
        
        // 简单的字符串哈希函数
        function hashCode(str) {
            let hash = 0;
            for (let i = 0, len = str.length; i < len; i++) {
                let chr = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + chr;
                hash |= 0; // Convert to 32bit integer
            }
            return hash;
        }
        
        // 更新设备ID生成方式
        function getOrCreateDeviceId() {
            let deviceId = localStorage.getItem('coco_device_id');
            
            if (!deviceId) {
                deviceId = generateDeviceFingerprint();
                localStorage.setItem('coco_device_id', deviceId);
            }
            
            return deviceId;
        }
        
        // 在记录访问和下载函数中添加额外的防护
        function setupReferralTracking() {
            // 获取推荐码
            const urlParams = new URLSearchParams(window.location.search);
            const refCode = urlParams.get('ref');
            
            if (refCode) {
                try {
                    // 检查是否已记录过访问
                    const visitKey = 'visit_recorded_' + refCode;
                    const lastVisit = localStorage.getItem(visitKey);
                    const now = Date.now();
                    
                    // 如果24小时内已记录，则不再记录
                    if (lastVisit && (now - parseInt(lastVisit)) < 86400000) {
                        console.log('Visit already recorded for:', refCode);
                        return;
                    }
                    
                    // 使用可靠的设备ID
                    const reliableDeviceId = getOrCreateDeviceId();
                    
                    // 记录访问
                    fetch('/api/v1/referrals/record_visit/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                        },
                        body: JSON.stringify({
                            referrer_code: refCode,
                            device_id: reliableDeviceId
                        })
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.status === 'success') {
                            console.log('Visit recorded successfully');
                            // 标记已记录访问（存储时间戳）
                            localStorage.setItem(visitKey, now.toString());
                        } else {
                            console.error('Failed to record visit:', data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Failed to record visit:', error.message);
                    });
                    
                } catch (e) {
                    console.error('Failed to process referral:', e);
                }
            }
            
            // 修改下载链接事件处理
            console.log('Setting up download link event listeners');
            document.querySelectorAll('.download-link, .download-btn, [id="heroDownloadBtn"]').forEach(link => {
                console.log('Found download link:', link);
                link.addEventListener('click', async function(e) {
                    e.preventDefault();
                    console.log('Download link clicked');
                    
                    // 防止重复点击
                    if (this.getAttribute('data-downloading') === 'true') {
                        console.log('Download already in progress');
                        return;
                    }
                    
                    // 标记为正在下载，并禁用所有下载按钮
                    this.setAttribute('data-downloading', 'true');
                    document.querySelectorAll('.download-link, .download-btn, [id="heroDownloadBtn"]').forEach(btn => {
                        btn.style.opacity = '0.5';
                        btn.style.pointerEvents = 'none';
                    });
                    
                    // 保存原始文本，并显示加载状态
                    const originalText = this.innerHTML;
                    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 下载中...';
                    
                    const urlParams = new URLSearchParams(window.location.search);
                    const refCode = urlParams.get('ref');
                    
                    if (refCode) {
                        console.log('Recording download for ref code:', refCode);
                        
                        // 检查24小时内是否已经记录过此推荐码的下载
                        const downloadKey = 'download_recorded_' + refCode;
                        const lastDownload = localStorage.getItem(downloadKey);
                        const now = Date.now();
                        
                        // 如果24小时内已经为此推荐码记录过下载，直接下载
                        if (lastDownload && (now - parseInt(lastDownload)) < 86400000) {
                            console.log('Download already recorded for this referral code in last 24 hours');
                            // 直接下载，不记录
                            const deviceId = getOrCreateDeviceId();
                            const directUrl = new URL(this.href, window.location.origin);
                            directUrl.searchParams.set('temp_id', deviceId);
                            window.location.href = directUrl.toString();
                            return;
                        }
                        
                        try {
                            // 使用一致的设备指纹ID
                            const deviceId = getOrCreateDeviceId();
                            
                            // 记录下载事件前先确保URL中的temp_id与设备指纹一致
                            const currentUrl = new URL(this.href, window.location.origin);
                            currentUrl.searchParams.set('temp_id', deviceId);
                            
                            // Record download event - 使用相同的设备ID
                            const response = await fetch('/api/v1/referrals/record_web_download/', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    referrer_code: refCode,
                                    device_id: deviceId  // 保持一致性
                                }),
                            });

                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            
                            // 记录下载已完成 - 存储时间戳
                            localStorage.setItem(downloadKey, now.toString());

                            // 使用更新后的URL进行下载
                            window.location.href = currentUrl.toString();
                            
                        } catch (error) {
                            console.error('Failed to record download:', error);
                            // 恢复按钮状态
                            this.innerHTML = originalText;
                            document.querySelectorAll('.download-link, .download-btn, [id="heroDownloadBtn"]').forEach(btn => {
                                btn.style.opacity = '1';
                                btn.style.pointerEvents = 'auto';
                                btn.removeAttribute('data-downloading');
                            });
                            
                            // 即使记录失败也允许下载，但确保使用更新后的URL
                            const deviceId = getOrCreateDeviceId();
                            const fallbackUrl = new URL(this.href, window.location.origin);
                            fallbackUrl.searchParams.set('temp_id', deviceId);
                            window.location.href = fallbackUrl.toString();
                        }
                    } else {
                        // 没有推荐码时直接下载，但仍确保URL中包含设备指纹
                        const deviceId = getOrCreateDeviceId();
                        const directUrl = new URL(this.href, window.location.origin);
                        directUrl.searchParams.set('temp_id', deviceId);
                        window.location.href = directUrl.toString();
                    }
                });
            });
        }

        // 更新所有下载链接使用指纹设备ID
        function updateDownloadLinks() {
            const deviceId = getOrCreateDeviceId();
            const downloadLinks = document.querySelectorAll('.download-link, .download-btn, [id="heroDownloadBtn"]');
            
            downloadLinks.forEach(link => {
                try {
                    const url = new URL(link.href, window.location.origin);
                    url.searchParams.set('temp_id', deviceId);
                    link.href = url.toString();
                } catch (e) {
                    console.error('Failed to update download link:', e);
                }
            });
        }

        // 在页面加载时执行
        document.addEventListener('DOMContentLoaded', function() {
            setupReferralTracking();
            updateDownloadLinks();
        });

        // 也可以立即执行
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            setTimeout(function() {
                updateDownloadLinks();
            }, 1);
        }

        // Generate UUID function
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
    </script>

    <!-- Hero Section -->
    <section id="home" class="hero">
        <div class="hero-background">
            <div class="gradient-circle circle-1"></div>
            <div class="gradient-circle circle-2"></div>
            <div class="floating-coins">
                <img src="{% static 'website/images/coins/solana.png' %}" alt="Solana" class="coin coin-1">
                <img src="{% static 'website/images/coins/ethereum.png' %}" alt="Ethereum" class="coin coin-2">
                <img src="{% static 'website/images/coins/base.png' %}" alt="Dogecoin" class="coin coin-4">
            </div>
        </div>
        <div class="container">
            <div class="hero-content">
                <h1>Unlock Your Crypto Potential with Coco Wallet</h1>
                <p>Empower your wealth journey with AI-driven meme coin investments.</p>
                <div class="cta-group">
                    <a href="/download/app?ref={{ referrer_code }}&temp_id={{ temp_device_id }}" class="cta-button download-link" id="heroDownloadBtn">
                        <i class="fab fa-android"></i>
                        <span>Download Now</span>
                        <span class="version">v1.0.0</span>
                    </a>
                    <div class="app-stats">
                        <div class="stat">
                            <span class="stat-number">10K+</span>
                            <span class="stat-label">Downloads</span>
                        </div>
                        <div class="stat">
                            <span class="stat-number">4.8</span>
                            <span class="stat-label">Rating</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="hero-image">
                <div class="phone-mockup">
                    <object data="{% static 'website/images/app-screen.svg' %}" type="image/svg+xml" class="app-screen"></object>
                    <div class="phone-frame"></div>
                    <div class="phone-reflection"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- What is Coco Wallet Section -->
    <section id="about" class="about">
        <div class="container">
            <h2>Coco Wallet: AI-Powered Wealth Creation</h2>
            <p>Coco Wallet is a revolutionary mobile app designed to help you create wealth through intelligent investments in meme coins. With the power of AI agents, Coco Wallet identifies the best low-market-cap meme coins and helps you make smarter investment decisions. Whether you're new to crypto or an experienced investor, Coco Wallet is your trusted partner in navigating the exciting world of meme coins and others.</p>
        </div>
    </section>

    <!-- How it Works Section -->
    <section id="how-it-works" class="features">
        <div class="container">
            <h2>Smart, Simple, Secure</h2>
            <div class="features-grid">
                <div class="feature-card">
                    <i class="fas fa-robot"></i>
                    <h3>AI Agent Assistance</h3>
                    <p>Let our AI analyze market trends and identify promising opportunities.</p>
                </div>
                <div class="feature-card">
                    <i class="fas fa-coins"></i>
                    <h3>Meme Coins</h3>
                    <p>Access a curated selection of high-potential meme coins.</p>
                </div>
                <div class="feature-card">
                    <i class="fas fa-mobile-alt"></i>
                    <h3>Easy-to-Use Interface</h3>
                    <p>Simple and intuitive design for seamless trading experience.</p>
                </div>
            </div>
            <p class="note">Note: The AI agent will be live in the next version.</p>
        </div>
    </section>

    <!-- Why Meme Coins Section -->
    <section id="why-meme" class="why-meme">
        <div class="container">
            <h2>Why Invest in Meme Coins?</h2>
            <div class="meme-grid">
                <div class="meme-card">
                    <h3>High Reward Potential</h3>
                    <p>Meme coins can explode in value in a short time, creating massive returns.</p>
                </div>
                <div class="meme-card">
                    <h3>Community Driven</h3>
                    <p>Meme coins thrive on strong community support, often driven by viral trends and social media buzz.</p>
                </div>
                <div class="meme-card">
                    <h3>Low Barriers to Entry</h3>
                    <p>Most meme coins are inexpensive, allowing users to invest small amounts with the potential for large gains.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Getting Started Section -->
    <section id="getting-started" class="getting-started">
        <div class="container">
            <h2>Getting Started with Coco Wallet is Easy</h2>
            <div class="steps">
                <div class="step">
                    <div class="step-number">1</div>
                    <h3>Download Coco Wallet</h3>
                    <p>Available for Android, Coco Wallet is easy to set up.</p>
                </div>
                <div class="step">
                    <div class="step-number">2</div>
                    <h3>Set Up Your AI Agent</h3>
                    <p>Customize your preferences, and let the AI agent start recommending the best meme coins for you.</p>
                </div>
                <div class="step">
                    <div class="step-number">3</div>
                    <h3>Invest and Track</h3>
                    <p>Make your first purchase and monitor your investments in real-time with Coco Wallet's seamless tracking features.</p>
                </div>
            </div>
            <a href="/download/app?ref={{ referrer_code }}&temp_id={{ temp_device_id }}" class="cta-button download-link">Download Now and Start Investing</a>
        </div>
    </section>

    <!-- AI Agent Section -->
    <section id="ai-agent" class="ai-agent">
        <div class="container">
            <h2>Your Personal Investment Assistant</h2>
            <p>Coco Wallet's AI Agent works behind the scenes to provide personalized investment recommendations. By analyzing global market data, social media trends, and historical performance, it helps you make informed decisions. The more you use it, the smarter it gets, learning from your preferences and risk tolerance.</p>
        </div>
    </section>

    <!-- Target Audience Section -->
    <section id="target" class="target">
        <div class="container">
            <h2>Designed for Emerging Markets</h2>
            <p>Coco Wallet is tailored for users in Africa, Southeast Asia, and other regions where access to traditional investment opportunities is limited. These regions have seen rapid growth in the adoption of mobile technology and cryptocurrencies. With Coco Wallet, you can start your journey towards wealth creation with minimal initial investment and maximum potential for growth.</p>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-links">
                    <a href="#home">Home</a>
                    <a href="#how-it-works">How It Works</a>
                    <a href="/download/app?ref={{ referrer_code }}&temp_id={{ temp_device_id }}" class="download-link">Download App</a>
                    <a href="privacy.html">Privacy Policy</a>
                    <a href="terms.html">Terms of Service</a>
                    <a href="contact.html">Contact Us</a>
                </div>
                <div class="social-links">
                    <a href="#"><i class="fab fa-twitter"></i></a>
                    <a href="#"><i class="fab fa-facebook"></i></a>
                    <a href="#"><i class="fab fa-instagram"></i></a>
                    <a href="#"><i class="fab fa-linkedin"></i></a>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 Coco Wallet. All rights reserved.</p>
            </div>
        </div>
    </footer>
</body>
</html>